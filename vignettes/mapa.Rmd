---
title: "Functional Module Identification and Annotation for Pathway Analysis Results Using Large Language Models"
subtitle: "Detailed tutorial available at: http://www.shen-lab.org/mapa-tutorial/"
author:
- name: Xiaotao Shen
- name: Yifei Ge

date: "Created on 2021-12-04 and updated on `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: no
  pdf_document:
    toc: no
vignette: >
  %\VignetteIndexEntry{base_function}
  %\VignettePackage{massdataset}
  % \VignetteEngine{knitr::rmarkdown}
  % \usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = TRUE,
  out.width = "100%"
)
set.seed(123)
```

# Load Demo Data

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
library(mapa)
if(!require(massdataset)){
  remotes::install_gitlab("tidymass/massdataset")
}

data("demo_data_ora.rda", package = "mapa")
load("demo_data_ora.rda")
str(demo_data_ora)
```

# Data Preprocessing

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE, error=TRUE}
variable_info <-
  convert_id(
    data = demo_data_ora,
    query_type = "gene",
    from_id_type = "symbol",
    organism = "org.Mm.eg.db"
  )
```

# Pathway Enrichment

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE, error=TRUE}
enriched_pathways <-
  enrich_pathway(
    variable_info = variable_info,
    query_type = "gene",
    database = c("go", "kegg", "reactome"),
    save_to_local = FALSE,
    go.orgdb = "org.Mm.eg.db",
    go.keytype = "ENTREZID",
    go.ont = "ALL",
    kegg.organism = "mmu",
    kegg.keytype = "kegg",
    reactome.organism = "mouse",
    pvalueCutoff = 0.05,
    pAdjustMethod = "BH",
    qvalueCutoff = 0.2,
    minGSSize = 10,
    maxGSSize = 500,
    readable = FALSE,
    pool = FALSE
  )

```

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
enriched_pathways
```

# Pathway Similarity Calculation

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
sim_res <-
  merge_pathways(
    object = enriched_pathways,
    database = c("go", "kegg", "reactome"),
    p.adjust.cutoff.go = 0.05,
    go.orgdb = "org.Mm.eg.db",
    p.adjust.cutoff.kegg = 0.05,
    p.adjust.cutoff.reactome = 0.05,
    count.cutoff.go = 5,
    count.cutoff.kegg = 5,
    count.cutoff.reactome = 5,
    sim.cutoff.go = 0.5,
    sim.cutoff.kegg = 0.5,
    sim.cutoff.reactome = 0.5,
    measure.method.go = "Sim_XGraSM_2013",
    measure.method.kegg = "jaccard",
    measure.method.reactome = "jaccard",
    path = "result",
    save_to_local = FALSE
  )
```

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
sim_res
```

# Module Identification

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
enriched_functional_module <-
  get_functional_modules(
    object = sim_res,
    sim.cutoff = 0.55,
    cluster_method = "louvain",
    path = "result",
    save_to_local = FALSE
  )
```

# Quality Assessment

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
assess_result <- assess_clustering_quality(object = enriched_functional_module)
```

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
assess_result$evaluation_plot
```

# Data Visualization

## Enriched pathway barplot at different levels

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
plot_pathway_bar(
  object = enriched_functional_module,
  top_n = 15,
  level = "pathway",
  database = "go",
  x_axis_name = "RichFactor",
  line_type = "straight"
)

plot_pathway_bar(
  object = enriched_functional_module,
  top_n = 10,
  level = "pathway",
  database = "kegg",
  x_axis_name = "RichFactor",
  line_type = "meteor"
)

plot_pathway_bar(object = enriched_functional_module,
                 top_n = 15,
                 level = "module",
                 x_axis_name = "RichFactor",
                 line_type = "straight")

plot_pathway_bar(object = enriched_functional_module,
                 top_n = 15,
                 level = "functional_module",
                 x_axis_name = "qscore",
                 line_type = "straight")

```

## Detailed information for each module

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
plot_module_info(
    object = enriched_functional_module,
    level = "module",
    database = "go",
    module_id = "go_Module_1"
  )

# enriched_functional_module@merged_module$functional_module_result$module

plot_module_info(object = enriched_functional_module,
                 level = "functional_module",
                 module_id = "Functional_module_10")

```

## Functional Module Similarity Network

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}

plot_similarity_network(
  object = enriched_functional_module,
  level = "module",
  database = "go",
  degree_cutoff = 1
)

plot_similarity_network(
  object = enriched_functional_module,
  level = "functional_module",
  degree_cutoff = 1
)
```

# Relationship network for functional modules/modules/pathways/molecules

```{r,eval=FALSE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
object <-
  enriched_functional_module
object@merged_module$functional_module_result <-
  head(object@merged_module$functional_module_result, 2)
plot_relationship_network(
  object = object,
  include_functional_modules = TRUE,
  include_modules = TRUE,
  include_pathways = TRUE,
  include_molecules = TRUE,
  functional_module_text = TRUE,
  module_text = TRUE,
  pathway_text = TRUE,
  molecule_text = TRUE,
  circular_plot = FALSE,
  functional_module_arrange_position = TRUE,
  module_arrange_position = TRUE,
  pathway_arrange_position = TRUE,
  molecule_arrange_position = TRUE,
  functional_module_position_limits = c(0, 1),
  module_position_limits = c(0, 1),
  pathway_position_limits = c(0, 1),
  molecule_position_limits = c(0, 1)
)

plot_relationship_network(
  object = object,
  include_functional_modules = TRUE,
  include_modules = FALSE,
  include_pathways = FALSE,
  include_molecules = TRUE,
  functional_module_text = TRUE,
  module_text = TRUE,
  pathway_text = TRUE,
  molecule_text = TRUE,
  circular_plot = TRUE,
  functional_module_arrange_position = TRUE,
  module_arrange_position = TRUE,
  pathway_arrange_position = TRUE,
  molecule_arrange_position = TRUE,
  functional_module_position_limits = c(0, 1),
  module_position_limits = c(0, 1),
  pathway_position_limits = c(0, 1),
  molecule_position_limits = c(0, 1)
)

```

# Export results as excel

```{r,eval=FALSE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
export_functional_module(object = enriched_functional_module)
```

# Session information

```{r,eval=TRUE,warning=FALSE, R.options="", message=FALSE, cache=TRUE}
sessionInfo()
```
